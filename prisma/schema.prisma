// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Or your chosen database (e.g., mysql)
  url      = env("DATABASE_URL")
}

// --------------------
// ENUMS
// --------------------

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  SECRETARY
  PROCUREMENT_OFFICER
  TEACHER
  STUDENT
  HR_MANAGER
  ACCOUNTANT
  LIBRARIAN
  TRANSPORT_MANAGER
  HOSTEL_WARDEN
  PARENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// Parent absence explanation workflow
enum AbsenceExplanationStatus {
  NONE        // no request initiated
  REQUESTED   // teacher/admin requested explanation
  ANSWERED    // parent responded
  CLOSED      // closed by staff
}

enum FeeFrequency {
  ONE_TIME
  MONTHLY
  TERMLY // Or SEMESTERLY
  ANNUALLY
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  VOID
  CANCELLED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CREDIT_CARD
  MOBILE_MONEY
  ONLINE_GATEWAY
  OTHER
}

// Status for parent-initiated payment requests
enum PaymentRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PurchaseOrderStatus {
  PENDING
  APPROVED
  REJECTED
  ORDERED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

// Inventory Transactions
enum InventoryTransactionType {
  IN      // stock received into store
  OUT     // stock issued out of store
  ADJUST  // manual adjustment to a specific on-hand quantity
}

// Requests incoming from public site to create onboard a School
enum SchoolRequestStatus {
  NEW
  REVIEWING
  APPROVED
  REJECTED
  CONTACTED
}

// Account requests from individuals/orgs who want an admin account
enum AccountRequestStatus {
  NEW
  REVIEWING
  APPROVED
  REJECTED
  CONTACTED
}

// --------------------
// FINANCE RE-DESIGN ENUMS (Phase 1)
// --------------------

enum DiscountScope {
  STUDENT
  INVOICE
  LINE
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum ScholarshipType {
  PERCENTAGE
  FIXED
}

// --------------------
// CORE TENANCY & USERS
// --------------------

model School {
  id           String   @id @default(cuid())
  name         String   @unique
  address      String?
  contactInfo  String?
  logoUrl      String?
  subdomain    String?  @unique
  customDomain String?  @unique
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Feature flags
  hasParentAppAccess      Boolean @default(false)
  hasAutoTimetable        Boolean @default(false)
  hasFinanceModule        Boolean @default(false)
  hasAdvancedHRModule     Boolean @default(false)
  hasProcurementModule    Boolean @default(false)
  hasLibraryModule        Boolean @default(false)
  hasTransportationModule Boolean @default(false)
  hasHostelModule         Boolean @default(false)

  // New timetable settings
  timetableStartTime String @default("08:00")
  timetableEndTime   String @default("17:00")

  // Relations
  users         User[]
  parents       Parent[]
  schoolLevels  SchoolLevel[]
  academicYears AcademicYear[]
  subjects      Subject[]
  staffMembers  Staff[]
  students      Student[]
  departments   Department[]
  announcements Announcement[]
  announcementReads AnnouncementRead[]

  events                  Event[]
  gradingScales           GradingScale[]
  classes                 Class[]
  sections                Section[]
  studentEnrollments      StudentEnrollment[]
  staffLevelAssignments   StaffLevelAssignment[]
  staffSubjectLevels      StaffSubjectLevel[] // Back-relation from StaffSubjectLevel
  subjectSchoolLevelLinks SubjectSchoolLevel[] // Back-relation from SubjectSchoolLevel
  attendances             Attendance[]
  staffAttendances        StaffAttendance[]
  assignments             Assignment[]
  submittedAssignments    SubmittedAssignment[]
  grades                  Grade[]
  exams                   Exam[]
  examSchedules           ExamSchedule[]
  examSubjectLinks        ExamSubject[]
  timetableEntries        TimetableEntry[]
  feeStructures           FeeStructure[]
  invoices                Invoice[]
  expenses                Expense[]
  expenseCategories       ExpenseCategory[]
  vendors                 Vendor[]
  purchaseOrders          PurchaseOrder[]
  inventoryCategories     InventoryCategory[]
  inventoryItems          InventoryItem[]
  invoiceItems            InvoiceItem[]
  payments                Payment[]
  // Finance redesign relations (Phase 1 additions)
  feeStructureComponents  FeeStructureComponent[]
  studentFeeAssignments   StudentFeeAssignment[]
  discounts               Discount[]
  scholarships            Scholarship[]
  paymentAllocations      PaymentAllocation[]
  purchaseOrderItems      PurchaseOrderItem[]
  leaveTypes              LeaveType[]
  leaveApplications       LeaveApplication[]
  payrollRecords          PayrollRecord[]
  terms                   Term[]
  GradingWeightConfig     GradingWeightConfig[] // UPDATED: Now links to GradingScale
  buildings               Building[]
  rooms                   Room[]
  hostels                 Hostel[]
  vehicles                Vehicle[]
  routes                  Route[]
  drivers                 Driver[]
  books                   Book[]
  bookLoans               BookLoan[]
  paymentRequests         PaymentRequest[]
  HostelRoom              HostelRoom[]
  inventoryTransactions   InventoryTransaction[]
  // Advanced Timetable relations
  sectionSubjectRequirements SectionSubjectRequirement[]
  staffUnavailabilities      StaffUnavailability[]
  roomUnavailabilities       RoomUnavailability[]
  pinnedTimetableSlots       PinnedTimetableSlot[]
  timetableRuns              TimetableRun[]
  absenceExplanations        AbsenceExplanation[]
  incomingRequests           SchoolRequest[]

  @@index([subdomain])
  @@index([customDomain])
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  hashedPassword    String
  firstName         String?
  lastName          String?
  phoneNumber       String?
  profilePictureUrl String?
  role              UserRole
  isActive          Boolean   @default(true)
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  staffProfile   Staff? // One-to-one with Staff if user is staff
  studentProfile Student? // One-to-one with Student if user is student
  parentProfile  Parent? // One-to-one with Parent if user is parent

  staffAttendancesTaken   StaffAttendance[] @relation("StaffAttendanceTakenBy")
  studentAttendancesTaken Attendance[]      @relation("TakenBy")
  paymentsProcessed       Payment[]         @relation("ProcessedBy")
  expensesPaid            Expense[]         @relation("PaidByExpense")
  gradesPublished         Grade[]           @relation("GradePublishedBy")
  inventoryTransactionsPerformed InventoryTransaction[] @relation("InventoryTransactionsPerformed")
  announcementReads AnnouncementRead[]
  absenceExplanationsRequested AbsenceExplanation[] @relation("AbsenceRequestedBy")
  requestLogs RequestLog[]
  accountRequestLogs AccountRequestLog[]

  @@index([email])
  @@index([schoolId])
}

model Parent {
  id        String   @id @default(cuid())
  userId    String   @unique // Link to User model
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students ParentStudent[] // Link to students
  schoolId String
  school   School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  announcementReads AnnouncementRead[]
  absenceExplanationsResponded AbsenceExplanation[] @relation("AbsenceRespondedBy")
  paymentRequests PaymentRequest[]

  @@index([userId])
  @@index([schoolId])
}

// Public-facing request to create an admin account (separate from School onboarding)
model AccountRequest {
  id             String               @id @default(cuid())
  status         AccountRequestStatus @default(NEW)
  requesterName  String
  requesterEmail String
  requesterPhone String?
  organization   String?
  message        String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  logs           AccountRequestLog[]

  @@index([status, createdAt])
}

// Audit log for account request status changes and notes
model AccountRequestLog {
  id           String          @id @default(cuid())
  accountRequestId String
  accountRequest AccountRequest @relation(fields: [accountRequestId], references: [id], onDelete: Cascade)
  actorUserId  String?
  actorUser    User?           @relation(fields: [actorUserId], references: [id], onDelete: SetNull)
  action       String          // e.g., CREATED, STATUS_CHANGE, NOTE_ADDED
  notes        String?
  createdAt    DateTime        @default(now())

  @@index([accountRequestId, createdAt])
  @@index([actorUserId])
}

// Public-facing request to onboard a new School
model SchoolRequest {
  id            String               @id @default(cuid())
  status        SchoolRequestStatus  @default(NEW)
  requesterName String
  requesterEmail String
  requesterPhone String?
  schoolName    String
  subdomain     String?
  message       String?
  requestedModules String[] @default([])
  schoolId      String?              // set when converted/linked to a real School
  school        School?              @relation(fields: [schoolId], references: [id], onDelete: SetNull)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  logs          RequestLog[]

  @@index([status, createdAt])
  @@index([schoolId])
}

// Audit log for request status changes and notes
model RequestLog {
  id            String      @id @default(cuid())
  requestId     String
  request       SchoolRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  actorUserId   String?
  actorUser     User?       @relation(fields: [actorUserId], references: [id], onDelete: SetNull)
  action        String      // e.g., CREATED, STATUS_CHANGE, NOTE_ADDED
  notes         String?
  createdAt     DateTime    @default(now())

  @@index([requestId, createdAt])
  @@index([actorUserId])
}

// Linking table for Parent and Student (Many-to-Many)
model ParentStudent {
  parentId          String
  parent            Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)
  studentId         String
  student           Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  relationToStudent String?
  isPrimaryContact  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([parentId, studentId])
  @@index([studentId])
  @@index([parentId])
}

model SchoolLevel {
  id          String  @id @default(cuid())
  name        String
  description String?
  schoolId    String
  school      School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classes               Class[]
  staffLevelAssignments StaffLevelAssignment[]
  staffSubjectLevels    StaffSubjectLevel[]    @relation("LevelSubjectsTaught")
  subjectLinks          SubjectSchoolLevel[]
  feeStructures         FeeStructure[]         @relation("LevelFeeStructures")
  studentFeeAssignments StudentFeeAssignment[]

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  GradingWeightConfig GradingWeightConfig[]
  // No direct relation to GradingScale here, it's done via GradingWeightConfig

  @@unique([schoolId, name])
  @@index([schoolId])
}

model AcademicYear {
  id        String   @id @default(cuid())
  name      String
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  terms               Term[]
  enrollments         StudentEnrollment[]
  grades              Grade[]
  feeStructures       FeeStructure[]        @relation("YearFeeStructures")
  classes             Class[]
  studentFeeAssignments StudentFeeAssignment[]
  scholarships         Scholarship[]
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  GradingWeightConfig GradingWeightConfig[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Term {
  id             String       @id @default(cuid())
  name           String
  startDate      DateTime
  endDate        DateTime
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  schoolId       String
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  grades    Grade[]
  exams     Exam[]   @relation("TermExams")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([academicYearId, name])
  @@index([schoolId])
}

model Department {
  id          String  @id @default(cuid())
  name        String
  description String?
  schoolId    String
  school      School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  subjects  Subject[]
  staff     Staff[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Class {
  id             String       @id @default(cuid())
  name           String
  schoolId       String
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  schoolLevelId  String
  schoolLevel    SchoolLevel  @relation(fields: [schoolLevelId], references: [id], onDelete: Cascade)
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  sections            Section[]
  subjects            Subject[]             @relation("ClassSubjects")
  staffSubjectLevels  StaffSubjectLevel[]
  assignments         Assignment[]          @relation("ClassAssignments")
  feeStructures       FeeStructure[]        @relation("ClassFeeStructures")
  studentFeeAssignments StudentFeeAssignment[]
  createdAt           DateTime              @default(now())
  examSchedules       ExamSchedule[]
  updatedAt           DateTime              @updatedAt
  GradingWeightConfig GradingWeightConfig[]

  @@unique([schoolId, name, academicYearId, schoolLevelId], map: "UQ_Class_School_Name_Year_Level")
  @@index([schoolId])
  @@index([schoolLevelId])
  @@index([academicYearId])
}

model Section {
  id             String  @id @default(cuid())
  name           String
  maxCapacity    Int?
  classId        String
  class          Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  classTeacherId String? @unique
  classTeacher   Staff?  @relation("ClassTeacherForSection", fields: [classTeacherId], references: [id], onDelete: SetNull)
  schoolId       String
  school         School  @relation(fields: [schoolId], references: [id], onDelete: Restrict)

  studentEnrollments StudentEnrollment[]
  timetableEntries   TimetableEntry[]
  sectionSubjectRequirements SectionSubjectRequirement[]
  pinnedTimetableSlots       PinnedTimetableSlot[]
  attendances        Attendance[]        @relation("SectionAttendances")
  assignments        Assignment[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  Grade              Grade[]
  

  @@unique([classId, name], map: "UQ_Section_Class_Name")
  @@index([schoolId])
  @@index([classTeacherId])
}

model Subject {
  id           String      @id @default(cuid())
  name         String
  subjectCode  String?
  weeklyHours  Float?
  description  String?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  schoolId     String
  school       School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classes             Class[]               @relation("ClassSubjects")
  staffSubjectLevels  StaffSubjectLevel[]
  assignments         Assignment[]
  examSubjects        ExamSubject[]
  grades              Grade[]
  examSchedules       ExamSchedule[]        @relation("SubjectExamSchedules")
  timetableEntries    TimetableEntry[]      @relation("SubjectTimetableSlots")
  sectionSubjectRequirements SectionSubjectRequirement[]
  pinnedTimetableSlots       PinnedTimetableSlot[]
  schoolLevelLinks    SubjectSchoolLevel[]
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  GradingWeightConfig GradingWeightConfig[]

  @@unique([schoolId, name])
  @@unique([schoolId, subjectCode])
  @@index([schoolId])
}

// Explicit Many-to-Many linking table for Subjects and SchoolLevels
model SubjectSchoolLevel {
  id            String      @id @default(cuid())
  subjectId     String
  subject       Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  schoolLevelId String
  schoolLevel   SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Cascade)
  schoolId      String
  school        School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  assignedAt    DateTime    @default(now())

  @@unique([subjectId, schoolLevelId, schoolId])
  @@index([schoolId])
}

model Student {
  id              String    @id @default(cuid())
  firstName       String
  lastName        String
  middleName      String?
  studentIdNumber String
  admissionDate   DateTime  @default(now())
  dateOfBirth     DateTime?
  gender          Gender?
  email           String?   @unique
  phone           String?
  address         String?
  city            String?
  state           String?
  country         String?

  guardianName     String?
  guardianRelation String?
  guardianPhone    String?
  guardianEmail    String?

  userId   String? @unique
  user     User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  schoolId String
  school   School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  parents              ParentStudent[]
  enrollments          StudentEnrollment[]
  grades               Grade[]
  submittedAssignments SubmittedAssignment[]
  invoices             Invoice[]
  studentFeeAssignments StudentFeeAssignment[]
  discounts            Discount[]
  scholarships         Scholarship[]
  bookLoans            BookLoan[]
  paymentRequests      PaymentRequest[]
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  hostelRoomId String?
  hostelRoom   HostelRoom? @relation(fields: [hostelRoomId], references: [id], onDelete: SetNull)

  @@unique([schoolId, studentIdNumber])
  @@index([userId])
  @@index([schoolId])
  @@index([hostelRoomId])
}

model StudentEnrollment {
  id             String       @id @default(cuid())
  studentId      String
  student        Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  sectionId      String
  section        Section      @relation(fields: [sectionId], references: [id], onDelete: Restrict)
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Restrict)
  schoolId       String
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Restrict)

  enrollmentDate DateTime @default(now())
  isCurrent      Boolean  @default(true)
  status         String?
  rollNumber     String?

  attendances Attendance[] @relation("EnrollmentAttendances")
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([studentId, academicYearId], map: "UQ_Student_AcademicYear_Enrollment")
  @@index([schoolId])
  @@index([sectionId])
  @@index([academicYearId])
  @@index([studentId])
}

model Staff {
  id            String      @id @default(cuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  staffIdNumber String
  jobTitle      String
  qualification String?
  dateOfJoining DateTime    @default(now())
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  schoolId      String
  school        School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  isClassTeacherForSections Section[]              @relation("ClassTeacherForSection")
  assignedLevels            StaffLevelAssignment[]
  taughtSubjectLevels       StaffSubjectLevel[]
  assignmentsCreated        Assignment[]
  attendances               StaffAttendance[]
  leaveApplications         LeaveApplication[]
  payrollRecords            PayrollRecord[]
  timetableEntries          TimetableEntry[]
  staffUnavailabilities     StaffUnavailability[]
  pinnedTimetableSlots      PinnedTimetableSlot[]
  hostels                   Hostel[]
  drivers                   Driver[]
  maxWeeklyTeachingHours    Float?
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt

  @@unique([schoolId, staffIdNumber])
  @@index([userId])
  @@index([schoolId])
}

// Linking table for Staff and SchoolLevel (General assignment)
model StaffLevelAssignment {
  staffId       String
  staff         Staff       @relation(fields: [staffId], references: [id], onDelete: Cascade)
  schoolLevelId String
  schoolLevel   SchoolLevel @relation(fields: [schoolLevelId], references: [id], onDelete: Cascade)
  assignedAt    DateTime    @default(now())
  schoolId      String
  school        School      @relation(fields: [schoolId], references: [id], onDelete: Restrict)

  @@id([staffId, schoolLevelId])
  @@index([schoolId])
}

// Linking table for Staff, Subject, SchoolLevel (and optionally Class)
model StaffSubjectLevel {
  id            String      @id @default(cuid())
  staffId       String
  staff         Staff       @relation(fields: [staffId], references: [id], onDelete: Cascade)
  subjectId     String
  subject       Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  schoolLevelId String
  schoolLevel   SchoolLevel @relation("LevelSubjectsTaught", fields: [schoolLevelId], references: [id], onDelete: Cascade)
  classId       String?
  class         Class?      @relation(fields: [classId], references: [id], onDelete: Cascade)
  schoolId      String
  school        School      @relation(fields: [schoolId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, subjectId, schoolLevelId, classId, schoolId], map: "UQ_Staff_Subject_Level_Class_School")
  @@index([schoolId])
  @@index([staffId])
  @@index([subjectId])
  @@index([schoolLevelId])
  @@index([classId])
}

// --------------------
// ATTENDANCE
// --------------------
model Attendance {
  id                  String            @id @default(cuid())
  studentEnrollmentId String
  studentEnrollment   StudentEnrollment @relation("EnrollmentAttendances", fields: [studentEnrollmentId], references: [id], onDelete: Cascade)
  sectionId           String
  section             Section           @relation("SectionAttendances", fields: [sectionId], references: [id], onDelete: Cascade)
  date                DateTime          @db.Date
  status              AttendanceStatus
  remarks             String?
  takenById           String
  takenBy             User              @relation("TakenBy", fields: [takenById], references: [id], onDelete: Restrict)
  schoolId            String
  school              School            @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relationship: one attendance can have one active absence explanation thread
  absenceExplanations AbsenceExplanation[]

  @@unique([studentEnrollmentId, date])
  @@unique([sectionId, date, studentEnrollmentId], map: "UQ_Attendance_Section_Date_Enrollment")
  @@index([schoolId, date])
  @@index([takenById])
}

model StaffAttendance {
  id        String           @id @default(cuid())
  staffId   String
  staff     Staff            @relation(fields: [staffId], references: [id], onDelete: Cascade)
  date      DateTime         @db.Date
  status    AttendanceStatus
  remarks   String?
  takenById String
  takenBy   User             @relation("StaffAttendanceTakenBy", fields: [takenById], references: [id], onDelete: Restrict)
  schoolId  String
  school    School           @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([staffId, date])
  @@index([schoolId, date])
  @@index([takenById])
}

model AbsenceExplanation {
  id             String                     @id @default(cuid())
  attendanceId   String
  attendance     Attendance                  @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  schoolId       String
  school         School                      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  status         AbsenceExplanationStatus    @default(REQUESTED)
  requestNote    String?                     @db.Text
  requestedById  String?                     // userId of teacher/admin who requested
  requestedBy    User?                       @relation("AbsenceRequestedBy", fields: [requestedById], references: [id], onDelete: SetNull)
  responseText   String?                     @db.Text
  respondedById  String?                     // parentId responding
  respondedBy    Parent?                     @relation("AbsenceRespondedBy", fields: [respondedById], references: [id], onDelete: SetNull)
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt

  @@index([attendanceId])
  @@index([schoolId])
}

// --------------------
// ASSIGNMENTS & GRADES
// --------------------
model Assignment {
  id                   String                @id @default(cuid())
  title                String
  description          String?               @db.Text
  dueDate              DateTime
  subjectId            String
  subject              Subject               @relation(fields: [subjectId], references: [id])
  sectionId            String?
  section              Section?              @relation(fields: [sectionId], references: [id])
  classId              String?
  class                Class?                @relation("ClassAssignments", fields: [classId], references: [id])
  teacherId            String
  teacher              Staff                 @relation(fields: [teacherId], references: [id])
  maxMarks             Float?
  attachments          Json?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  schoolId             String
  school               School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  submittedAssignments SubmittedAssignment[]
  Grade                Grade[]

  @@index([schoolId, subjectId])
  @@index([sectionId])
  @@index([classId])
}

model SubmittedAssignment {
  id            String     @id @default(cuid())
  assignmentId  String
  assignment    Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  studentId     String
  student       Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  submittedAt   DateTime   @default(now())
  content       String?    @db.Text
  attachments   Json?
  marksObtained Float?
  feedback      String?    @db.Text
  gradedById    String?
  gradedAt      DateTime?
  schoolId      String
  school        School     @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@unique([assignmentId, studentId])
  @@index([schoolId])
}

model GradingScale {
  id                  String                @id @default(cuid())
  name                String
  description         String?
  schoolId            String
  school              School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  gradeDetails        GradeDetail[]
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  GradingWeightConfig GradingWeightConfig[]

  @@unique([schoolId, name])
}

model GradeDetail {
  id             String       @id @default(cuid())
  gradingScaleId String
  gradingScale   GradingScale @relation(fields: [gradingScaleId], references: [id], onDelete: Cascade)
  grade          String
  minPercentage  Float
  maxPercentage  Float
  gpaValue       Float?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([gradingScaleId, grade])
}

model Grade {
  id             String        @id @default(cuid())
  studentId      String
  student        Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  subjectId      String
  subject        Subject       @relation(fields: [subjectId], references: [id])
  examScheduleId String?
  examSchedule   ExamSchedule? @relation(fields: [examScheduleId], references: [id], onDelete: SetNull)
  termId         String
  term           Term          @relation(fields: [termId], references: [id])
  academicYearId String
  academicYear   AcademicYear  @relation(fields: [academicYearId], references: [id])
  marksObtained  Float?
  gradeLetter    String?
  gpa            Float?
  comments       String?
  schoolId       String
  sectionId      String // The ID of the section taking this specific exam
  section        Section       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // NEW: Link to Assignment (if grade is for an assignment)
  assignmentId String? // Foreign key to Assignment
  assignment   Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)

  // Publication control: once published, only SCHOOL_ADMIN (and SUPER_ADMIN) can modify
  isPublished    Boolean   @default(false)
  publishedAt    DateTime?
  publishedById  String?
  publishedBy    User?     @relation("GradePublishedBy", fields: [publishedById], references: [id], onDelete: SetNull)

  @@unique([studentId, examScheduleId, subjectId])
  @@index([studentId, subjectId, academicYearId])
  @@index([schoolId])
  @@index([assignmentId]) // New index
  @@index([isPublished])
}

model GradingWeightConfig {
  id             String       @id @default(cuid())
  schoolId       String
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  schoolLevelId  String?
  schoolLevel    SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  classId        String?
  class          Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  subjectId      String?
  subject        Subject?     @relation(fields: [subjectId], references: [id], onDelete: SetNull)

  gradingScaleId String? // NEW: Link to the GradingScale used for this configuration
  gradingScale   GradingScale? @relation(fields: [gradingScaleId], references: [id], onDelete: SetNull)

  examWeight       Float
  classworkWeight  Float
  assignmentWeight Float

  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, academicYearId, schoolLevelId, classId, subjectId])
  @@index([schoolId, academicYearId])
  @@index([schoolLevelId])
  @@index([classId])
  @@index([subjectId])
  @@index([gradingScaleId]) // NEW INDEX
}

model Exam {
  id               String         @id @default(cuid())
  name             String
  termId           String
  term             Term           @relation("TermExams", fields: [termId], references: [id], onDelete: Cascade)
  schoolId         String
  school           School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  examSchedules    ExamSchedule[] @relation("ExamSchedules")
  examSubjectLinks ExamSubject[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([schoolId, termId, name])
}

model ExamSchedule { 
  id          String    @id @default(cuid())
  examId      String
  exam        Exam      @relation("ExamSchedules", fields: [examId], references: [id], onDelete: Cascade)
  subjectId   String
  subject     Subject   @relation("SubjectExamSchedules", fields: [subjectId], references: [id])
  
  // ✨ ADD THESE TWO LINES TO LINK TO A CLASS ✨
  classId     String
  class       Class     @relation(fields: [classId], references: [id], onDelete: Cascade)

  date        DateTime
  startTime   String
  endTime     String
  maxMarks    Float
  room        String?
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  grades      Grade[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([examId, subjectId, classId]) // A subject can be scheduled once per exam for a given class
  @@index([schoolId, examId, subjectId])
}

model ExamSubject {
  examId       String
  exam         Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  subjectId    String
  subject      Subject  @relation(fields: [subjectId], references: [id])
  maxMarks     Float?
  passingMarks Float?
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@id([examId, subjectId])
  @@index([schoolId])
}

// --------------------
// TIMETABLE
// --------------------
model TimetableEntry {
  id        String   @id @default(cuid())
  sectionId String
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject  @relation("SubjectTimetableSlots", fields: [subjectId], references: [id])
  staffId   String
  staff     Staff    @relation(fields: [staffId], references: [id])
  dayOfWeek Int
  startTime String
  endTime   String
  roomId    String?
  room      Room?    @relation("TimetableRoomSlots", fields: [roomId], references: [id], onDelete: SetNull)
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  generatedByRunId String?
  generatedByRun   TimetableRun? @relation(fields: [generatedByRunId], references: [id], onDelete: SetNull)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, sectionId, dayOfWeek, startTime])
  @@unique([schoolId, staffId, dayOfWeek, startTime])
  @@unique([schoolId, roomId, dayOfWeek, startTime])
  @@index([schoolId, sectionId, dayOfWeek])
  @@index([schoolId, staffId, dayOfWeek])
  @@index([schoolId, roomId, dayOfWeek])
  @@index([generatedByRunId])
}

// Advanced timetable: per-section subject requirements (periods per week, duration, spacing)
model SectionSubjectRequirement {
  id               String  @id @default(cuid())
  schoolId         String
  school           School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  sectionId        String
  section          Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subjectId        String
  subject          Subject @relation(fields: [subjectId], references: [id])
  periodsPerWeek   Int
  durationMinutes  Int     @default(60)
  minGapMins       Int     @default(0) // minimum minutes between two sessions of this subject within a section per day
  allowDouble      Boolean @default(false) // allow back-to-back double periods
  preferredRoomType String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([schoolId, sectionId, subjectId])
  @@index([schoolId])
  @@index([sectionId])
  @@index([subjectId])
}

// Teacher unavailability windows (hard constraints)
model StaffUnavailability {
  id        String   @id @default(cuid())
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  staffId   String
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  dayOfWeek Int
  startTime String
  endTime   String
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([staffId, dayOfWeek])
}

// Room unavailability windows (maintenance, exams, etc.)
model RoomUnavailability {
  id        String   @id @default(cuid())
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  dayOfWeek Int
  startTime String
  endTime   String
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([roomId, dayOfWeek])
}

// Pinned (fixed) slots that the generator must respect
model PinnedTimetableSlot {
  id        String   @id @default(cuid())
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  sectionId String
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id])
  staffId   String?
  staff     Staff?   @relation(fields: [staffId], references: [id], onDelete: SetNull)
  roomId    String?
  room      Room?    @relation(fields: [roomId], references: [id], onDelete: SetNull)
  dayOfWeek Int
  startTime String
  endTime   String
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([sectionId, dayOfWeek, startTime])
}

// Timetable generation runs & placements (draft results before publish)
enum TimetableRunStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
  CANCELED
}

model TimetableRun {
  id          String               @id @default(cuid())
  schoolId    String
  school      School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  name        String?
  status      TimetableRunStatus   @default(PENDING)
  optionsJson Json?
  metricsJson Json?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  placements  TimetablePlacement[]
  generatedEntries TimetableEntry[]

  @@index([schoolId])
}

model TimetablePlacement {
  id        String   @id @default(cuid())
  runId     String
  run       TimetableRun @relation(fields: [runId], references: [id], onDelete: Cascade)
  schoolId  String
  sectionId String
  subjectId String
  staffId   String
  roomId    String?
  dayOfWeek Int
  startTime String
  endTime   String
  score     Float?
  violations Int? @default(0)
  createdAt DateTime @default(now())

  @@index([runId])
  @@index([schoolId])
  @@unique([runId, sectionId, dayOfWeek, startTime])
}

// --------------------
// COMMUNICATION
// --------------------
model Announcement {
  id          String    @id @default(cuid())
  title       String
  content     String    @db.Text
  publishedAt DateTime?
  audience    Json?
  isGlobal    Boolean   @default(false)
  schoolId    String?
  school      School?   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  authorId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  reads       AnnouncementRead[]

  @@index([schoolId, publishedAt])
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?   @db.Text
  startDate   DateTime
  endDate     DateTime?
  location    String?
  isGlobal    Boolean   @default(false)
  schoolId    String?
  school      School?   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([schoolId, startDate])
}

// Track which users (parents) have read an announcement
model AnnouncementRead {
  id             String       @id @default(cuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentId       String?
  parent         Parent?      @relation(fields: [parentId], references: [id], onDelete: SetNull)
  schoolId       String
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  readAt         DateTime     @default(now())
  createdAt      DateTime     @default(now())

  @@unique([announcementId, userId])
  @@index([schoolId])
  @@index([userId])
  @@index([parentId])
}

// --------------------
// FINANCE MODULE
// --------------------
model FeeStructure {
  id             String        @id @default(cuid())
  name           String
  description    String?
  amount         Float
  frequency      FeeFrequency
  academicYearId String
  academicYear   AcademicYear  @relation("YearFeeStructures", fields: [academicYearId], references: [id])
  classId        String?
  class          Class?        @relation("ClassFeeStructures", fields: [classId], references: [id])
  schoolLevelId  String?
  schoolLevel    SchoolLevel?  @relation("LevelFeeStructures", fields: [schoolLevelId], references: [id], onDelete: SetNull)
  schoolId       String
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  invoiceItems   InvoiceItem[]
  components     FeeStructureComponent[]
  studentFeeAssignments StudentFeeAssignment[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@unique([schoolId, name, academicYearId, classId, schoolLevelId])
  @@index([schoolId])
  @@index([academicYearId])
  @@index([classId])
  @@index([schoolLevelId])
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  studentId     String
  student       Student       @relation(fields: [studentId], references: [id], onDelete: Restrict)
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  totalAmount   Float
  paidAmount    Float         @default(0)
  status        InvoiceStatus @default(DRAFT)
  notes         String?
  schoolId      String
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  items         InvoiceItem[]
  payments      Payment[]
  discounts     Discount[]
  allocations   PaymentAllocation[]
  paymentRequests PaymentRequest[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([schoolId, studentId, status])
}

model InvoiceItem {
  id              String         @id @default(cuid())
  invoiceId       String
  invoice         Invoice        @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  feeStructureId  String?
  feeStructure    FeeStructure?  @relation(fields: [feeStructureId], references: [id], onDelete: SetNull)
  description     String
  quantity        Int            @default(1)
  unitPrice       Float
  totalPrice      Float
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  // Finance redesign: link back to a specific component if applicable
  feeStructureComponentId String?
  feeStructureComponent   FeeStructureComponent? @relation(fields: [feeStructureComponentId], references: [id], onDelete: SetNull)
  schoolId        String
  school          School         @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  discounts       Discount[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([schoolId])
}

model Payment {
  id            String        @id @default(cuid())
  // Legacy single-invoice field retained temporarily for backward compatibility (will be nullable later)
  invoiceId     String?
  invoice       Invoice?      @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  paymentDate   DateTime      @default(now())
  amount        Float
  paymentMethod PaymentMethod
  referenceId   String?
  notes         String?
  processedById String? // User ID
  processedBy   User?         @relation("ProcessedBy", fields: [processedById], references: [id], onDelete: SetNull)
  schoolId      String
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  allocations   PaymentAllocation[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([schoolId, invoiceId])
  @@index([processedById])
}

// --------------------
// FINANCE REDESIGN MODELS (Phase 1)
// --------------------

model FeeStructureComponent {
  id             String       @id @default(cuid())
  feeStructureId String
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  amount         Float        // Component portion; feeStructure.amount may be legacy (can be derived sum)
  order          Int          @default(0)
  schoolId       String
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  invoiceItems   InvoiceItem[]

  @@index([schoolId])
  @@index([feeStructureId])
}

model StudentFeeAssignment {
  id               String       @id @default(cuid())
  studentId        String
  student          Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  feeStructureId   String
  feeStructure     FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  academicYearId   String
  academicYear     AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  schoolLevelId    String?
  schoolLevel      SchoolLevel? @relation(fields: [schoolLevelId], references: [id], onDelete: SetNull)
  classId          String?
  class            Class?       @relation(fields: [classId], references: [id], onDelete: SetNull)
  effectiveFrom    DateTime?    // Optional start (for recurring logic)
  effectiveTo      DateTime?    // Optional end
  isActive         Boolean      @default(true)
  schoolId         String
  school           School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@unique([studentId, feeStructureId, academicYearId], map: "UQ_Student_FeeStructure_Year")
  @@index([schoolId])
  @@index([academicYearId])
  @@index([classId])
}

model Discount {
  id             String        @id @default(cuid())
  scope          DiscountScope
  type           DiscountType
  percentage     Float?        // If type = PERCENTAGE
  amount         Float?        // If type = FIXED
  reason         String?
  studentId      String?       // scope STUDENT
  student        Student?      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  invoiceId      String?       // scope INVOICE
  invoice        Invoice?      @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  invoiceItemId  String?       // scope LINE (InvoiceItem)
  invoiceItem    InvoiceItem?  @relation(fields: [invoiceItemId], references: [id], onDelete: Cascade)
  schoolId       String
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([schoolId])
  @@index([studentId])
  @@index([invoiceId])
  @@index([invoiceItemId])
}

model Scholarship {
  id             String        @id @default(cuid())
  studentId      String
  student        Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  academicYearId String
  academicYear   AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  type           ScholarshipType
  percentage     Float?        // if PERCENTAGE
  amount         Float?        // if FIXED per invoice OR per component (applied logic layer)
  notes          String?
  isActive       Boolean       @default(true)
  schoolId       String
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@unique([studentId, academicYearId], map: "UQ_Scholarship_Student_Year")
  @@index([schoolId])
}

model PaymentAllocation {
  id         String   @id @default(cuid())
  paymentId  String
  payment    Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  amount     Float
  createdAt  DateTime @default(now())
  schoolId   String
  school     School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([invoiceId])
  @@index([paymentId])
}

// Parent-submitted payment requests awaiting staff verification/processing
model PaymentRequest {
  id         String                 @id @default(cuid())
  invoiceId  String
  invoice    Invoice                @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  studentId  String
  student    Student                @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parentId   String
  parent     Parent                 @relation(fields: [parentId], references: [id], onDelete: Cascade)
  amount     Float
  method     PaymentMethod?
  reference  String?
  status     PaymentRequestStatus   @default(PENDING)
  metadata   Json?
  createdAt  DateTime               @default(now())
  processedAt DateTime?
  schoolId   String
  school     School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([invoiceId])
  @@index([parentId])
  @@index([studentId])
}

model ExpenseCategory {
  id          String    @id @default(cuid())
  name        String
  description String?
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  expenses    Expense[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([schoolId, name])
}

model Expense {
  id          String          @id @default(cuid())
  description String
  amount      Float
  date        DateTime
  categoryId  String
  category    ExpenseCategory @relation(fields: [categoryId], references: [id])
  vendorId    String?
  vendor      Vendor?         @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  receiptUrl  String?
  paidById    String // User ID of staff who recorded/paid
  paidBy      User            @relation("PaidByExpense", fields: [paidById], references: [id], onDelete: Restrict)
  schoolId    String
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([schoolId, date])
  @@index([paidById])
}

model LeaveType {
  id                String             @id @default(cuid())
  name              String
  defaultDays       Int?
  schoolId          String
  school            School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  leaveApplications LeaveApplication[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@unique([schoolId, name])
}

model LeaveApplication {
  id           String      @id @default(cuid())
  staffId      String
  staff        Staff       @relation(fields: [staffId], references: [id])
  leaveTypeId  String
  leaveType    LeaveType   @relation(fields: [leaveTypeId], references: [id])
  startDate    DateTime
  endDate      DateTime
  reason       String?
  status       LeaveStatus @default(PENDING)
  approvedById String?
  comments     String?
  appliedOn    DateTime    @default(now())
  schoolId     String
  school       School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([schoolId, staffId, status])
}

model PayrollRecord {
  id             String    @id @default(cuid())
  staffId        String
  staff          Staff     @relation(fields: [staffId], references: [id])
  payPeriodStart DateTime
  payPeriodEnd   DateTime
  basicSalary    Float
  allowances     Float?
  deductions     Float?
  netSalary      Float
  paymentDate    DateTime?
  isPaid         Boolean   @default(false)
  schoolId       String
  school         School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([staffId, payPeriodStart, payPeriodEnd])
  @@index([schoolId])
}

model Vendor {
  id             String          @id @default(cuid())
  name           String
  contactPerson  String?
  email          String?
  phone          String?
  address        String?
  schoolId       String
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]
  expenses       Expense[]
  inventoryTransactions InventoryTransaction[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
}

model PurchaseOrder {
  id                   String              @id @default(cuid())
  orderNumber          String              @unique
  vendorId             String
  vendor               Vendor              @relation(fields: [vendorId], references: [id])
  orderDate            DateTime            @default(now())
  expectedDeliveryDate DateTime?
  totalAmount          Float
  status               PurchaseOrderStatus @default(PENDING)
  notes                String?
  approvedById         String?
  schoolId             String
  school               School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  items                PurchaseOrderItem[]
  inventoryTransactions InventoryTransaction[]
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  @@index([schoolId, vendorId])
}

model PurchaseOrderItem {
  id              String         @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder  @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  itemName        String
  description     String?
  quantity        Int
  unitPrice       Float
  totalPrice      Float
  inventoryItemId String?
  inventoryItem   InventoryItem? @relation(fields: [inventoryItemId], references: [id], onDelete: SetNull)
  schoolId        String
  school          School         @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([schoolId])
}

model InventoryCategory {
  id        String          @id @default(cuid())
  name      String
  schoolId  String
  school    School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  items     InventoryItem[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([schoolId, name])
}

model InventoryItem {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  categoryId         String?
  category           InventoryCategory?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  quantityInStock    Int                 @default(0)
  reorderLevel       Int?
  supplierInfo       String?
  schoolId           String
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  purchaseOrderItems PurchaseOrderItem[]
  transactions       InventoryTransaction[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  InvoiceItem        InvoiceItem[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model InventoryTransaction {
  id                 String                     @id @default(cuid())
  itemId             String
  item               InventoryItem              @relation(fields: [itemId], references: [id], onDelete: Cascade)
  schoolId           String
  school             School                     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  type               InventoryTransactionType
  quantity           Int                        // for IN/OUT this is the magnitude; for ADJUST this is the delta applied
  resultingQuantity  Int                        // on-hand after this transaction
  reason             String?
  reference          String?                    // free-text reference like doc number
  vendorId           String?
  vendor             Vendor?                    @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  purchaseOrderId    String?
  purchaseOrder      PurchaseOrder?             @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  performedByUserId  String?
  performedBy        User?                      @relation("InventoryTransactionsPerformed", fields: [performedByUserId], references: [id], onDelete: SetNull)
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt

  @@index([schoolId, itemId])
}

model Building {
  id        String   @id @default(cuid())
  name      String
  location  String?
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  rooms     Room[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Room {
  id               String           @id @default(cuid())
  name             String
  roomType         String?
  capacity         Int?
  buildingId       String?
  building         Building?        @relation(fields: [buildingId], references: [id], onDelete: SetNull)
  schoolId         String
  school           School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  timetableEntries TimetableEntry[] @relation("TimetableRoomSlots")
  roomUnavailabilities RoomUnavailability[]
  pinnedTimetableSlots PinnedTimetableSlot[]
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([buildingId])
}

// --------------------
// HOSTEL MODULE
// --------------------

model Hostel {
  id               String       @id @default(cuid())
  name             String
  genderPreference String?
  capacity         Int?
  wardenId         String?
  warden           Staff?       @relation(fields: [wardenId], references: [id], onDelete: SetNull)
  schoolId         String
  school           School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  rooms            HostelRoom[]
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
  @@index([wardenId])
}

model HostelRoom {
  id               String    @id @default(cuid())
  roomNumber       String
  hostelId         String
  hostel           Hostel    @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  roomType         String?
  bedCapacity      Int
  currentOccupancy Int       @default(0)
  pricePerTerm     Float?
  schoolId         String
  school           School    @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  students         Student[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([hostelId, roomNumber])
  @@index([schoolId])
  @@index([hostelId])
}

// --------------------
// TRANSPORTATION MODULE
// --------------------

model Vehicle {
  id                 String   @id @default(cuid())
  registrationNumber String   @unique
  make               String?
  model              String?
  capacity           Int?
  status             String?
  schoolId           String
  school             School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([schoolId, registrationNumber])
  @@index([schoolId])
}

model Route {
  id          String   @id @default(cuid())
  name        String
  description String?
  stops       Json?
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Driver {
  id            String   @id @default(cuid())
  staffId       String   @unique
  staff         Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  licenseNumber String   @unique
  contactNumber String?
  schoolId      String
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Restrict)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([schoolId, staffId])
  @@unique([schoolId, licenseNumber])
  @@index([schoolId])
  @@index([staffId])
}

// --------------------
// LIBRARY MODULE
// --------------------

model Book {
  id              String   @id @default(cuid())
  title           String
  author          String
  isbn            String?  @unique
  publicationYear Int?
  genre           String?
  copiesAvailable Int      @default(1)
  schoolId        String
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  loans           BookLoan[]

  @@unique([schoolId, isbn])
  @@index([schoolId])
  @@index([title])
  @@index([author])
}

// Loan status for library borrow/return lifecycle
enum LoanStatus {
  BORROWED
  RETURNED
  OVERDUE
}

// Tracks a borrowing of a book copy by a student
model BookLoan {
  id         String     @id @default(cuid())
  schoolId   String
  school     School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  bookId     String
  book       Book       @relation(fields: [bookId], references: [id], onDelete: Restrict)

  studentId  String
  student    Student    @relation(fields: [studentId], references: [id], onDelete: Restrict)

  quantity   Int        @default(1)
  borrowedAt DateTime   @default(now())
  dueDate    DateTime?
  returnedAt DateTime?
  status     LoanStatus @default(BORROWED)

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([schoolId])
  @@index([bookId])
  @@index([studentId])
  @@index([status])
}
